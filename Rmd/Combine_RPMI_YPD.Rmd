---
title: "RPMI_YPD combined Plate Reader analysis"
author: "Liz Hughes"
date: "23/11/2022"
output:
  html_document:
    toc: yes
    toc_depth: 2
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: '2'
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE , warning=FALSE, message=FALSE)
```


This analysis takes parts from Rmd files RPMI_PR_20200728.Rmd and nYPD_PR_20200807.Rmd to create a combined figure.
Test WT H99 and Gat 201 deletion mutants 003(Madhani) and 004(Bahn)in RPMI and YPD at 37 degrees in TECAN plate reader.
7 Bioreps, 3 Techreps each. (NB only 2 Techreps for Biorep 7)
Grow 5ml culture from colony (1 colony = 1 Biorep)in YPD, 30C, 250 rpm ON.
Seed at OD 600nm = 0.2 , 200 ul per well.
Run for 3 days.

```{r load_packages}
library(tidyverse)
library(reshape2)
library(cowplot)
library(extrafont)


theme_set(
  theme_cowplot(font_size = 12, font_family = "Arial",
                rel_large = 1) + 
    theme(strip.background = element_blank(),
          panel.border = 
            element_rect(color = "grey90", 
                         fill = NA, 
                         linetype = 1, 
                         size = 1),
          panel.grid.major.y = 
            element_line(size = 0.5, 
                         colour = "grey90"))
)

```


# Set up data frame of nice strain names, colours, styles.

```{r nice_names}
strain_df <- tibble( Strain = c("H99", "Gat201(B)", "Gat201(M)", "C26", "C30" ),
                     Strain_nice = c("GAT201", "gat201∆b","gat201∆m", "GAT201-C1", "GAT201-C2"),
                     colour = c("grey20", "magenta3", "darkred", "blue3", "cyan4"))

scale_color_strain <- 
  scale_color_manual("Strain",
                     breaks = strain_df$Strain_nice,
                     values = strain_df$colour)

scale_time_hrs <- 
  scale_x_continuous(name = "Time (hours)", 
                     breaks = c(0, 12, 24, 48, 72),
                     limits = c(0, 72),
                     expand = c(0, 0))
```



# Read in transposed data as csv file RPMI

Also change time from seconds to hours.

```{r csv_file}
rawod_rpmi <- 
  read.csv("../Input/20200728_EH_PR2_RPMI_WT_Gat201TRSP.csv") %>%
  mutate(Time = Time/3600)
```



# Read in the Plate map data from csv file RPMI

Also combine with nice strain names for display

```{r Load_platemap}

platemap_rpmi <- 
  read.csv("../Input/20200728-PR2_SetupCSV.csv") %>%
  left_join(strain_df, by = "Strain")
head(platemap_rpmi, n=10)

```

# Reshape data and combine with the plate map, pairing them by Well RPMI

```{r reshape_annotate}
annotated_rpmi <- 
  rawod_rpmi %>%
  # Tidy the data using the melt function from reshape2
  melt(id=c("Time", "Temp"), 
       variable.name="Well",
       value.name="OD595") %>%
  # Annotate by joining with the platemap
  inner_join(platemap_rpmi, by="Well")

```

## Calculate median OD for blank wells for each growth medium RPMI
Remove well H2

```{r calc_blank_medians}
blank_OD_summary_rpmi <- annotated_rpmi %>%
  filter(Strain=="") %>%
  filter(Well != "H2") %>%
  # filter out columns 1 and 12 as well?
  group_by(Medium) %>%
  summarise(OD_median = median(OD595),
            OD_mean   = mean(OD595),
            OD_max    = max(OD595),
            OD_min    = min(OD595))

print(blank_OD_summary_rpmi)
```

# Subtract blank OD to make corrected OD and Plot OD_corrected v Time (hrs) RPMI

```{r subtract_blank_OD}

normalisedOD_rpmi <- annotated_rpmi %>%
  left_join(blank_OD_summary_rpmi, by="Medium") %>%
  mutate(OD_corrected = OD595 - OD_median)

```

## Plot OD all stat_summary(geom -"line") Highlight summary line RPMI

```{r plot_all_stat_summary}
RPMI_plot <- ggplot(data=normalisedOD_rpmi %>%
                      filter(Strain != ""), 
                    aes(x=Time, y=OD_corrected, color=Strain_nice)) + 
  geom_line(aes(group = Well), size = 0.2, alpha = 0.2) + 
  stat_summary(fun = "median", geom = "line", size = 1) +
  scale_time_hrs + 
  # scale_y_continuous(limits = c(0, 0.9), 
  #                    expand = c(0, 0), 
  #                    breaks = c(0, 0.25, 0.5, 0.75)) +
  scale_y_continuous(limits = c(0, 0.1),
                     expand = c(0, 0),
                     breaks = c(0, 0.05, 0.1)) +
  labs(y = "OD595",
       title = "RPMI") +
  scale_color_strain

RPMI_plot
```


```{r save_RPMI.png}
ggsave("../Results/RPMI.png",width = 5.1,height=5)
```

# Read in transposed data as csv file YPD

```{r y_csv_file }
rawod_ypd <- 
  read.csv("../Input/20200807_EH_PR4_YPD_WTGat201_TRSP.csv") %>%
  mutate(Time = Time/3600)

```


# Read in the Plate map data from csv file YPD

```{r y_Load_platemap}
platemap_ypd <- 
  read.csv("../Input/20200807-PR4_SetupCSV.csv") %>%
  left_join(strain_df, by = "Strain")

head(platemap_ypd, n=10)

```

# Combine the reshaped data with the plate map, pairing them by Well YPD

# Reshape data and combine with the plate map, pairing them by Well RPMI

```{r reshape_annotate_ypd}
annotated_ypd <- 
  rawod_ypd %>%
  # Tidy the data using the melt function from reshape2
  melt(id=c("Time", "Temp"), 
       variable.name="Well",
       value.name="OD595") %>%
  # Annotate by joining with the platemap
  inner_join(platemap_ypd, by="Well")

```


## Calculate median OD for blank wells for each growth medium RPMI
Remove well H2

```{r calc_blank_medians_ypd}
blank_OD_summary_ypd <- annotated_ypd %>%
  filter(Strain=="") %>%
  filter(Well != "H2") %>%
  # filter out columns 1 and 12 as well?
  group_by(Medium) %>%
  summarise(OD_median = median(OD595),
            OD_mean   = mean(OD595),
            OD_max    = max(OD595),
            OD_min    = min(OD595))

print(blank_OD_summary_ypd)
```

# Subtract blank OD to make corrected OD and Plot OD_corrected v Time (hrs) RPMI

```{r subtract_blank_OD_ypd}

normalisedOD_ypd <- annotated_ypd %>%
  left_join(blank_OD_summary_ypd, by="Medium") %>%
  mutate(OD_corrected = OD595 - OD_median)

```

## Plot OD all stat_summary(geom -"line") Highlight summary line RPMI

```{r plot_all_stat_summary_ypd}
YPD_plot <- ggplot(data=normalisedOD_ypd %>%
                      filter(Strain != ""), 
                    aes(x=Time, y=OD_corrected, color=Strain_nice)) + 
  geom_line(aes(group = Well), size = 0.2, alpha = 0.2) + 
  stat_summary(fun = "median", geom = "line", size = 1) +
  scale_time_hrs + 
  scale_y_continuous(limits = c(0, 0.9), 
                     expand = c(0, 0),
                     breaks = c(0, 0.1, 0.25, 0.5, 0.75)) +
  labs(y = "OD595",
       title = "YPD") +
  scale_color_strain

YPD_plot
```

```{r save_YPD.png}

ggsave("../Results/YPD.png",width = 6.6,height=5)
```

# Draft Multipanel Figure

```{r multifig, fig.height = 4, fig.width = 3.75}

plot_grid(
  RPMI_plot,
  YPD_plot,
  ncol = 1)

```


```{r save_png}
ggsave(filename = "../results/fig_platereader.png", width = 3.75, height = 4)
```

```{r save_svg}
ggsave(filename = "../results/fig_platereader.svg", width = 3.75, height = 4)
```


























